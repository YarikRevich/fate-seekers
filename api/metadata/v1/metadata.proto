syntax = "proto3";
option go_package = "github.com/YarikRevich/fate-seekers/pkg/core/networking/metadata/api";

import "google/protobuf/timestamp.proto";
import "buf/validate/validate.proto";

package metadata.v1;

// Represents service used to retrieve user content related data.
// All the metadata requests require authentication header to be provided, having JWT token saved in it.
service MetadataService {
    // PingConnection performs ping connection and creates user record on the server side at the same time, 
    // if such does not exist.
    rpc PingConnection(PingConnectionRequest) returns (PingConnectionResponse) {};

    // UpdateSessionActivity performs session activity update.
    rpc UpdateSessionActivity(stream UpdateSessionActivityRequest) returns (UpdateSessionActivityResponse) {};

    // CreateUserIfNotExists performs attempt to create a user, if it hasn't been create yet.
    rpc CreateUserIfNotExists(CreateUserIfNotExistsRequest) returns (CreateUserIfNotExistsResponse) {};

    // GetUserSessions performs existing sessions retrieval operation by the configured user.
    rpc GetUserSessions(GetUserSessionsRequest) returns (GetUserSessionsResponse) {};

    // GetFilteredSession performs existing filtered session retrieval operation by the configured user.
    rpc GetFilteredSession(GetFilteredSessionRequest) returns (GetFilteredSessionResponse) {};

    // CreateSession performs session creation operation by the configured user.
    rpc CreateSession(CreateSessionRequest) returns (CreateSessionResponse) {};

    // RemoveSession performs session removal operation by the configured user. Allowed for session owner only.
    rpc RemoveSession(RemoveSessionRequest) returns (RemoveSessionResponse) {};

    // StartSession performs start session operation by the configured user. Allowed for session host only.
    rpc StartSession(StartSessionRequest) returns (StartSessionResponse) {};

    // GetSessionMetadata performs session metadata retrieval request by the configured user.
    rpc GetSessionMetadata(GetSessionMetadataRequest) returns (stream GetSessionMetadataResponse) {};

    // GetLobbySet performs existing lobbies retrieval operation by the provided session id, by the configured user.
    rpc GetLobbySet(GetLobbySetRequest) returns (stream GetLobbySetResponse) {};

    // CreateLobby performs lobby creation operation by the configured user.
    rpc CreateLobby(CreateLobbyRequest) returns (CreateLobbyResponse) {};

    // RemoveLobby performs lobby removal operation by the configured user. Allowed for lobby owner only.
    rpc RemoveLobby(RemoveLobbyRequest) returns (RemoveLobbyResponse) {};

    // LeaveLobby performs lobby leave operation by the configured user.
    rpc LeaveLobby(LeaveLobbyRequest) returns (LeaveLobbyResponse) {};

    // GetUsersMetadata performs users metadata retrieval request by the configured user.
    rpc GetUsersMetadata(GetUsersMetadataRequest) returns (stream GetUsersMetadataResponse) {};

    // GetUserInventory performs user inventory retrieval request by the configured user.
    rpc GetUserInventory(GetUserInventoryRequest) returns (stream GetUserInventoryResponse) {};

    // TakeChestItem performs chest item take operaiton for the selected chest by the configured user.
    rpc TakeChestItem(TakeChestItemRequest) returns (TakeChestItemResponse) {};

    // OpenChest performs chest open operation for the selected chest by the configured user.
    rpc OpenChest(OpenChestRequest) returns (OpenChestResponse) {};

    // GetChests performs chests retrieval for the selected session by the configured user.
    rpc GetChests(GetChestsRequest) returns (stream GetChestsResponse) {};

    // OpenHealthPack performs health pack open operation for the selected health pack by the configured user.
    rpc OpenHealthPack(OpenHealthPackRequest) returns (OpenHealthPackResponse) {};

    // GetHealthPacks performs health packs retrieval for the selected session by the configured user.
    rpc GetHealthPacks(GetHealthPacksRequest) returns (stream GetHealthPacksResponse) {};

    // GetEvents performs weather events retrieval for the selected session by the configured user.
    rpc GetEvents(GetEventsRequest) returns (stream GetEventsResponse) {};

    // GetMap performs map retrieval for the selected session by the configured user.
    rpc GetMap(GetMapRequest) returns (stream GetMapResponse) {};
    
    // GetChatMessages performs chat messages retrieval for the selected session by the configured user.
    rpc GetChatMessages(GetChatMessagesRequest) returns (stream GetChatMessagesResponse) {};

    // CreateChatMessage performs chat message creation for the selected session by the configured user.
    rpc CreateChatMessage(CreateChatMessageRequest) returns (CreateChatMessageResponse) {};
}

// PingConnectionRequest represents  ping connection request message.
message PingConnectionRequest {
    string issuer = 1 [(buf.validate.field).string.uuid = true];
};

// PingConnectionResponse represents ping connection response message.
message PingConnectionResponse {
};

// UpdateSessionActivityRequest represents session update request message.
message UpdateSessionActivityRequest {
    string issuer = 1 [(buf.validate.field).string.uuid = true];
};

// UpdateSessionActivityResponse represents session update response message.
message UpdateSessionActivityResponse {
    
};

// CreateUserIfNotExistsRequest represents user creation attempt request message.
message CreateUserIfNotExistsRequest {
    string issuer = 1 [(buf.validate.field).string.uuid = true];
};

// CreateUserIfNotExistsRequest represents user creation attempt response message.
message CreateUserIfNotExistsResponse {

};

// GetUserSessionsRequest represents get user sesssions request.
message GetUserSessionsRequest {
    string issuer = 1 [(buf.validate.field).string.uuid = true];
};

// Session represents common session retrieval message.
message Session {
    int64 session_id = 1; 
    uint64 seed = 2;
    string name = 3;
}

// GetUserSessionsResponse represents get user sesssions response.
message GetUserSessionsResponse {
    repeated Session sessions = 1;
};


// GetFilteredSessionRequest represents get filtered user sessions request.
message GetFilteredSessionRequest {
    string name = 1 [(buf.validate.field).string.pattern = "^[a-zA-Z0-9-]{8}$"];
};

// GetFilteredSessionResponse represents get filtered user sessions response.
message GetFilteredSessionResponse {
    Session session = 1;
};

// CreateSessionRequest represents create session request.
// User is allowed to create only 3 sessions in 10 minutes.
message CreateSessionRequest {
    string name = 1 [(buf.validate.field).string.pattern = "^[a-zA-Z0-9-]{8}$"];
    string issuer = 2 [(buf.validate.field).string.uuid = true];
    optional uint64 seed = 3 ;
};

// CreateSessionResponse represents create session response.
message CreateSessionResponse {
    int64 session_id = 1;
};

// RemoveSessionRequest represents remove session request.
message RemoveSessionRequest {
    int64 session_id = 1;
    string issuer = 2 [(buf.validate.field).string.uuid = true];
};

// RemoveSessionResponse represents remove session response.
message RemoveSessionResponse {
};

// StartSessionRequest represents start session request
message StartSessionRequest {
    int64 session_id = 1;
    int64 lobby_id = 2;
    repeated Position spawnables = 3;
    repeated Position chest_locations = 4;
    repeated Position health_pack_locations = 5;
    string issuer = 6 [(buf.validate.field).string.uuid = true];
};

// StartSessionResponse represents start session response.
message StartSessionResponse {
};

// GetSessionMetadataRequest represents session metadata request.
message GetSessionMetadataRequest {
    int64 session_id = 1;
    string issuer = 2 [(buf.validate.field).string.uuid = true];
};

// GetSessionMetadataResponse represents session metadata response.
message GetSessionMetadataResponse {
    bool started = 1;
};

// GetLobbySetRequest represents user create lobby request.
message GetLobbySetRequest {
    int64 session_id = 1;
    string issuer = 2 [(buf.validate.field).string.uuid = true];
};

// LobbySetUnit represents lobby set metadata unit.
message LobbySetUnit {
    int64 lobby_id = 1;
    string issuer = 2 [(buf.validate.field).string.uuid = true];
    uint64 skin = 3;
    bool host = 4;
};

// GetLobbySetResponse represents user create lobby response.
message GetLobbySetResponse {
    repeated LobbySetUnit lobby_set = 1;
};

// CreateLobbyRequest represents user create lobby request.
message CreateLobbyRequest {
    int64 session_id = 1;
    string issuer = 2 [(buf.validate.field).string.uuid = true];
};

// CreateLobbyResponse represents user create lobby response.
message CreateLobbyResponse {  
};

// RemoveLobbyRequest represents user remove lobby request.
message RemoveLobbyRequest {
    int64 session_id = 1;
    string issuer = 2 [(buf.validate.field).string.uuid = true];
};

// RemoveLobbyResponse represents user remove lobby response.
message RemoveLobbyResponse {
};

// LeaveLobbyRequest represents user leave lobby request.
message LeaveLobbyRequest {
    int64 session_id = 1;
    string issuer = 2 [(buf.validate.field).string.uuid = true];
};

// LeaveLobbyResponse represents user leave lobby response.
message LeaveLobbyResponse {
};

// GetUsersMetadataRequest represents users metadata retrieval request message.
message GetUsersMetadataRequest {
    int64 session_id = 1;
    string issuer = 2 [(buf.validate.field).string.uuid = true];
};

// UserMetadata represents common user metadata message.
message UserMetadata {
    string issuer = 1 [(buf.validate.field).string.uuid = true];
    uint64 health = 2;
    uint64 skin = 3;
    bool eliminated = 4;
    bool active = 5;
    Position position = 6;

    // Represents current animation state.
    bool static = 7;
};

// GetUsersMetadataResponse represents users metadata retrieval response message.
message GetUsersMetadataResponse {
    repeated UserMetadata user_metadata = 1;
};

// GetUserInventoryRequest represents user inventory retrieval response message.
message GetUserInventoryRequest {
    string issuer = 1 [(buf.validate.field).string.uuid = true];
    int64 session_id = 2;
};

// UserInventoryItem represents user inventory item message.
message UserInventoryItem {
    string name = 1;
};

// GetUserInventoryResponse represents user inventory response message
message GetUserInventoryResponse {
    repeated UserInventoryItem user_inventory_items = 1;
};  

// Position represents common position message.
message Position {
    double x = 1;
    double y = 2;
};

// TakeChestItemRequest represents take chest item operation request.
message TakeChestItemRequest {
    int64 session_id = 1;
    int64 generation_id = 2;
    int64 association_id = 3;
    string issuer = 4 [(buf.validate.field).string.uuid = true];
};

// TakeChestItemResponse represents take chest item opereation response.
message TakeChestItemResponse {

};

// OpenChestRequest represents chest open request.
message OpenChestRequest {
    int64 session_id = 1;
    int64 generation_id = 2;
    string issuer = 3 [(buf.validate.field).string.uuid = true];
};

// OpenChestResponse represents chest open response.
message OpenChestResponse {
};

// GetChestsRequest represents chests retrieval request message.
message GetChestsRequest {
    int64 session_id = 1;
    string issuer = 2 [(buf.validate.field).string.uuid = true];
};

// ChestItem represents chest item message.
message ChestItem {
    int64 chest_item_id = 1;
    string name = 2;
};

// Chest represents chest message.
message Chest {
    int64 chest_id = 1;
    Position position = 2;
    bool active = 3;
    repeated ChestItem chest_items = 4;
};

// GetChestsResponse represents chests retrieval response streaming message.
message GetChestsResponse {
    repeated Chest chests = 1;
};

// OpenHealthPackRequest represents health pack open request.
message OpenHealthPackRequest {
    int64 session_id = 1;
    int64 generation_id = 2;
    string issuer = 3 [(buf.validate.field).string.uuid = true];
};

// OpenHealthPackResponse represents health pack open response.
message OpenHealthPackResponse {
};

// GetHealthPacksRequest represents health packs retrieval request message.
message GetHealthPacksRequest {
    int64 session_id = 1;
    string issuer = 2 [(buf.validate.field).string.uuid = true];
};

// HealthPack represents health pack message.
message HealthPack {
    int64 health_pack_id = 1;
    Position position = 2;
    bool active = 3;
};

// GetHealthPacksResponse represents health packs retrieval response streaming message.
message GetHealthPacksResponse {
    repeated HealthPack healthPacks = 1;
};

// GetEventsRequest represents event retrieval request message.
message GetEventsRequest {
    int64 session_id = 1;
    string issuer = 2 [(buf.validate.field).string.uuid = true];
};

// GetEventsResponse represents event retrieval response message.
message GetEventsResponse {
    string name = 1;
};

// GetMapRequest represents map retrieval request message.
message GetMapRequest {
    int64 session_id = 1;
};

// GetMapResponse represents map retrieval response streaming message.
message GetMapResponse {
    repeated Position positions = 1;
};

// GetChatMessagesRequest represents chat messages retrieval request message.
message GetChatMessagesRequest {
    int64 session_id = 1;
    uint64 offset = 2;
};

// ChatMessage represents common chat retrieval message.
message ChatMessage {
    string content = 1;
    string issuer = 2 [(buf.validate.field).string.uuid = true];
    google.protobuf.Timestamp timestamp = 3;
};

// GetChatMessagesResponse represents chat messages retrieval response streaming message.
message GetChatMessagesResponse {
    repeated ChatMessage messages = 1;
};

// CreateChatMessageRequest represents chat message creation request message.
message CreateChatMessageRequest {
    int64 session_id = 1;
    uint64 offset = 2;
};

// CreateChatMessageResponse represents chat message creation request message.
message CreateChatMessageResponse {
};